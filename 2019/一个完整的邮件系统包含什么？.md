前一段时间阅读 MIME 知识的时候，发现了一本老书《Programming Internet Email》，这本书讲的是邮件系统，但由于 MIME 实际上就是为了扩展邮件系统而产生的，所以里面涉及了很多 MIME 知识，看了前四章感觉非常好。

另外说到邮件系统，其实我现在的工作就是邮件 Web 开发，工作好几年了，但对整体的邮件架构其实很不了解。

所以本书给了我一个机会，那就是重新学习邮件系统，本书非常老，1999年出版的，虽然已经过了20年，互联网也发生了很大的变化，邮件协议也有了很大的演变，但本书仍然有很大的借鉴意义，但在读的时候，必须考虑那本书所在的时代。

写这篇文章主要表达的就是邮件系统是非常复杂的，具有很强的生命力，希望大家看完后，对于搭建邮件系统有一个简单的概念。而且通过了解邮件系统的历史，会让你对互联网发展有更深刻的理解。

- X.400 标准：从标准了解邮件系统的演变。
- 互联网邮件标准：现代化的邮件标准是怎么样的？
- 如何定义互联网邮件。
- 一个基本的邮件系统是如何运作的？

--- 

### X.400 标准

X.400 是 ISO 组织建立的一个邮件系统标准，一般情况下它和 X.500 标准一起使用。

X.400 标准太学术了，虽然远景很美好，但最后很多功能没有实现，有点类似于网络 ISO 七层标准的结局，最终被互联网邮件标准替代了。但在很多国家和企业眼中，ISO 标准具有法律效应，所以他们很推崇 X.400 标准。

X.400 标准最大的问题在于它定的时间太晚了，一些邮件厂商开发出各种不标准的邮件系统，本想着等 X.400 标准出来后，再切换过去。没想到互联网发展的如此迅速，等到 X.400 标准定下来的时候，太多 PC 已经使用了非标准的邮件系统，想让他们转为 X.400 标准的邮件系统根本不具备可操作性，所以邮件厂商一路走到黑，不采用 X.400 标准了。

即使使用 X.400 标准开发的邮件系统，必须兼容互联网邮件系统，考虑到 MIME 的扩展一直在更新，基于 X.400 标准的邮件系统如果通过专有网络升级进行兼容，代价会非常昂贵，普通用户根本不可能买账，这也是 X.400 标准没有发展起来的原因之一。

就这样 X.400 标准被无情的抛弃了，X.400 是不是很像网络 ISO 七层标准，而互联网邮件标准就像 TCP/IP 协议。正规军被野路子打败了。

### 互联网邮件标准 

由于 X.400 出来的太晚，很多厂商都各自实现了自己的邮件系统，有商业的，但大部分是免费的。经过不断的整合，“非标准的邮件标准”成为了实际的标准，这个标准是基于 TCP/IP 协议的。
 
早期的“Internet Mail System”就像互联网标准一样，是以一种非常松散的方式在协作，不断处于进化之中，也是一套开放规范，独立于邮件服务商。

早期互联网邮件标准虽然没有次序，但受益于互联网，也逐步完善了规范和通讯标准，直到现在这一模型也没有变。

提到互联网邮件标准，必须提到 MIME，对于 Web 开发者来说，虽然 MIME 不是 HTTP 协议的一部分，但却有非常重要的地位。

互联网邮件系统使用 MIME 扩展将文件添加到邮件中，MIME 描述了如何将二进制数据表示文本，这样基于文本的邮件就能够发送附件了。SMTP 和 MIME 是现代邮件系统的基础，称为 SMTP/MIME。

如果说 Web 是 TCP/IP 协议最大的应用，那么“Internet Mail System”则是 TCP/IP 协议最大的先驱。

### 定义互联网邮件系统

如何概念化“互联网邮件标准”很难，它由几个重要的单元组成，理解这些组成单元非常重要。

1：Mail user agent (MUA)

MUA是一个客户端程序，用于发送和接收邮件，MUA可以是一个软件，也可以是一个脚本，比如 Foxmail，Outlook 都是 MUA，普通用户主要接触到的也就是MUA。

2：Mail transfer agent (MTA)

MTA是一个服务器端程序，主要讲邮件从一台机器传输到另外一个服务器中，有发送 MTA，也有接收 MTA。

一般用户在 MUA 中配置的 SMTP 服务器就是 MTA，通过 SMTP 协议协作，是邮件系统中最重要的组成单元。sendmail 就是最流行的 MTA 软件。

3：Mail delivery agent (MDA)

MDA 是一个内部程序，主要被 MTA 调用，落信（将邮件投递到用户 mailbox）工作就是它完成的。

4：Mail retrieval agent (MRA)

MAR 是一个服务，主要用于从mailbox或者远程服务器上检索邮件到用户的 MUA 中，POP 协议和 IMAP 协议就是 MRA 的二个最重要实现。在 MUA 上一般要配置 POP 端口或 IMAP 端口。 

### 邮件系统的几个技术特征
 
从技术角度看，邮件系统是一个典型的**C/S分布式系统**，用户的所有收发操作都与服务器交互完成，和 Web  不同的是邮件服务商之间作为服务器端也必须互相协作。

互联网邮件系统都是**分层**架构，每一个单元（比如MTA、MDA、MUA、MRA）都完成特定的功能，但这些单元之间关系也是相当松散的，比如 MTA 可能会调用 MDA 的部分功能，甚至基于 MTA 可以扩展更多的功能。分层的一个例子就是 MTA 不会直接投递消息到接收者的mailbox，它会交给MDA去处理。

对于邮件服务商来说，只要保证服务对外符合**标准**即可，内部如何搭建没有太多的制约。

话虽如此，相对 Web 来说，搭建一个邮件系统其实是非常困难的，在搭建之前，如果对邮件系统的系统结构没有了解，那么是非常痛苦的，而且在理解的时候也会非常混乱。

对于一个普通用户来说，早期上网收发邮件来说是非常困难和昂贵的，不像现在大部分人用手机就直接能操作了。想表达一个什么意思呢？用户收发邮件其实并不是直接联网操作的，而是将所有的收发操作委托给本地（局域网）的 MTA 和 MRA 操作的，有点离线的概念。比如以前用户会设置本地的 SMTP 服务器发送邮件，而现在大部分邮件客户端（MUA）会直接远程调用用户邮件服务商的 SMTP 服务器发送，这也进一步说明邮件系统其实是非常**灵活**的，进一步复杂化了邮件系统。

在邮件系统中还有一个概念非常重要，那就是**网关**，现在互联网邮件系统的协议已经逐步标准化了，但以前由于有多种类型的邮件系统存在，为了让不同的邮件系统在不同的网络上进行通信，必须对邮件进行翻译，所以引入了网关这样一个功能。MUA 和 MTA 都可以充当网关的角色。sendmail 就是非常流行的一个 MTA，在早期它的主要目的就是为文本消息进行消息地址转换。

一个最基本的邮件系统是构建在SMTP协议之上的对等分布式系统，这也凸显出SMTP协议的重要性，MTA就是基于SMTP协议实现的服务。

邮件系统还有个重要的特征就是**异步化**，这也是早期互联网非规模化形成的，但现在看来异步化已经是邮件系统标志性的一个特征了。对于用户来说，SMTP （接收MTA）它不会告知你邮件是否已经到达指定用户的 mailbox（异步化机制和分层机制导致的，比如反垃圾会拒绝，MDA投递要时间），但在会话阶段会告诉你投递失败（比如遇到频率限制）。

### 一个基本的邮件系统是如何运作的？

先上图吧，真实系统比它更复杂，但从本图能窥探全貌。

![](14-mail-jg.png)

1：为外部系统而构建的网关
 
在描述这张图流程之前，再一次说说网关，这是一个很模糊的概念。本文全部看完，可能才会对它有清晰的认识。

一个外部邮件系统（比如非互联网邮件系统）希望发送一份邮件给互联网上的用户，就必须找到对应的网关，这个消息会被重写成互联网邮件消息，一般情况下发送 MTA 会完成这个功能。对内有网关，对外也有网关，所以才有了发送MTA和接收MTA的分类。

另外MUA也可以充当网关，比如它可以决定是将邮件发送给转发MTA，还是直接发送给收件人服务商对应的MTA。同时接收MTA也可能会发送邮件给其他一个网关，可见邮件系统确实很复杂，网关的界限也很模糊。
 
2：MUA 发送邮件

一个MUA需要有能力为用户初始化消息并发送给任意的收件人，大概的工作如下：

- 在MUA中配置适当的MTA。
- 将消息编写为合适的邮件格式。
- 调用 SMTP 协议将消息发送给用户选择的MTA服务器。

一般情况下，如果你在手机上配置的MTA 一般是要远程访问的；而如果你们企业自己搭建了邮件系统，配置的MTA可能就是本地的（不用走互联网）。 

3：MTA 传输邮件

MTA不会翻译邮件，比如不会解信，他们仅仅决定这封邮件下一步去哪儿，一个MTA会接收其他发送MTA发送的邮件也可能接收MUA的请求。MTA根据SMTP协议的Envelope information解析出邮件的发送者和接受者，然后对邮件进行正确的编码，根据情况决定转发给本地的MDA还是外部MTA。
 
MTA有个路由策略，根据收件人地址判断出收件人的mailbox是在本系统还是外部系统中，如果收件人在本地，就转发给本地的MDA；如果是外部账户，就投递给另外一个MDA，由它转发。

一个MAT无法知晓消息是否已经到达用户的mailbox，这个只能由收件MUA才能知道（就是收件人自己去看）。

MTA还有一个核心功能就是反垃圾，比如发送MTA发现邮件的发送者不是自己域的，就可能直接拒发。关于反垃圾有很高的技术要求，此处仅仅简单提一下。
 
MTA可以分为发送MTA和接收MTA，由于现在网络很普及化了，所以很少有发送MTA，发送MTA可能是为了满足特定需求，比如说我们公司的邮件系统，Web发送的邮件会转发给发送MTA，它不用校验身份，甚至通信协议也可以是私有协议（不用SMTP协议）。
 
4：MDA 投递邮件
 
MTA和MDA 有的时候是部署在一台服务器，通过系统调用访问，如果规模比较大，MTA和MDA可部署在不同的机器上。
 
MDA 的作用就是决定将信落在哪儿，如果收件人就是本地的用户，就直接投递到用户mailbox；如果收件人是其他邮件服务商的用户，就投递给其他MTA。
 
5：MRA检索邮件

说完邮件发送，接下去说说收邮件，用户可以使用不同的机制获取到邮件，这是MRA需要解决的问题。
 
一个MAR是一个C/S系统，服务器能够获访问用户的mailbox，而客户端一般集成在MUA上。

MRA有两种通用协议，就是SMTP和POP（可以认为是MRA的协议实现），他们是不同时代的产物。

6：MUA接收邮件

一旦邮件到了用户的mailbox，就能在本地或通过MRA获取，MRA一般集成在MUA上，由MUA进行排序、存档、显示。

使用最多的是交互式 MUAs，比如Foxmail，MUA 的功能相当强大，大家会深有体会。

--- 

欢迎关注我的公众号（ID：yudadanwx，虞大胆的叽叽喳喳）和书《深入浅出HTTPS：从原理到实战》。
 


 
